syntax = "proto3";

package depot.agent.v1;

import "depot/agent/v1/agent.proto";
import "google/protobuf/timestamp.proto";

service SandboxService {
  rpc StartSandbox(StartSandboxRequest) returns (StartSandboxResponse);
  rpc GetSandbox(GetSandboxRequest) returns (GetSandboxResponse);
  rpc ListSandboxs(ListSandboxsRequest) returns (ListSandboxsResponse);
  rpc KillSandbox(KillSandboxRequest) returns (KillSandboxResponse);
  rpc StreamSandboxLogs(StreamSandboxLogsRequest) returns (stream StreamSandboxLogsResponse);

  rpc AddSecret(AddSecretRequest) returns (AddSecretResponse);
  rpc RemoveSecret(RemoveSecretRequest) returns (RemoveSecretResponse);
  rpc ListSecrets(ListSecretsRequest) returns (ListSecretsResponse);

  // Shutdown is called from within the sandbox to gracefully terminate
  rpc Shutdown(ShutdownRequest) returns (ShutdownResponse);

  // GetSSHConnection retrieves SSH connection info for an existing sandbox
  rpc GetSSHConnection(GetSSHConnectionRequest) returns (GetSSHConnectionResponse);

  // ExecInSandbox executes a command in a running sandbox (no SSH required)
  rpc ExecInSandbox(ExecInSandboxRequest) returns (ExecInSandboxResponse);

  // Template management - save and reuse pre-configured sandbox filesystems
  rpc CreateSandboxTemplate(CreateSandboxTemplateRequest) returns (CreateSandboxTemplateResponse);
  rpc GetSandboxTemplate(GetSandboxTemplateRequest) returns (GetSandboxTemplateResponse);
  rpc ListSandboxTemplates(ListSandboxTemplatesRequest) returns (ListSandboxTemplatesResponse);
  rpc DeleteSandboxTemplate(DeleteSandboxTemplateRequest) returns (DeleteSandboxTemplateResponse);
}

message StartSandboxRequest {
  AgentType agent_type = 1;
  optional string session_id = 2;
  optional string resume_session_id = 3;
  string argv = 4;
  map<string, string> environment_variables = 5;
  Context context = 6;
  optional SSHConfig ssh_config = 7;
  // Start sandbox from a saved template (pre-configured filesystem)
  // When set, creates a fresh session with the template's filesystem state
  optional string template_id = 8;

  // Optional command to execute inside the sandbox after it starts
  optional string command = 9;
  // If true, block until the command exits and return the result.
  // If false (default), start the command and return immediately.
  optional bool wait_for_command = 10;

  // Optional custom image from the Depot Registry (registry.depot.dev/...)
  // Mutually exclusive with ssh_config and template_id
  optional string image = 11;

  message Context {
    oneof context {
      GitContext git = 1;
    }
    message GitContext {
      optional string secret_name = 1; // Name of the secret containing the Git credentials (optional for public repos)
      string repository_url = 2;
      optional string branch = 3;
      optional string commit_hash = 4;
    }
  }
}

message SSHConfig {
  bool enabled = 1;
  optional int32 timeout_minutes = 2;
}

message SSHConnection {
  string host = 1;
  int32 port = 2;
  string username = 3;
  string private_key = 4;
}

message CommandResult {
  int32 exit_code = 1;
  string stdout = 2;
  string stderr = 3;
}

message StartSandboxResponse {
  string sandbox_id = 1;
  string session_id = 2;
  string organization_id = 3;
  optional SSHConnection ssh_connection = 4;
  // Result of the command execution, only present when command and wait_for_command are set
  optional CommandResult command_result = 5;
}

message GetSSHConnectionRequest {
  string session_id = 1;
}

message GetSSHConnectionResponse {
  SSHConnection ssh_connection = 1;
}

message ExecInSandboxRequest {
  string sandbox_id = 1;
  string command = 2;
  // If true, block until the command exits and return the result.
  // If false (default), start the command and return immediately.
  optional bool wait_for_command = 3;
}

message ExecInSandboxResponse {
  // Result of the command execution, only present when wait_for_command is true
  optional CommandResult command_result = 1;
}

message GetSandboxRequest {
  string sandbox_id = 1;
}

message GetSandboxResponse {
  Sandbox sandbox = 1;
}

message AddSecretRequest {
  string secret_name = 1;
  optional string secret_description = 2;
  string secret_value = 3;
  optional AgentType agent_type = 4;
}

message AddSecretResponse {}

message RemoveSecretRequest {
  string secret_name = 1;
  optional AgentType agent_type = 2;
}

message RemoveSecretResponse {}

message ListSecretsRequest {
  optional AgentType agent_type = 1;
}

message ListSecretsResponse {
  repeated Secret secrets = 1;
}

message Secret {
  string name = 1;
  optional string description = 2;
  optional google.protobuf.Timestamp last_modified = 3;
}

message ListSandboxsRequest {
  optional int32 page_size = 1;
  optional string page_token = 2;
  optional AgentType agent_type = 3; // Filter by agent type
}

message ListSandboxsResponse {
  repeated Sandbox sandboxes = 1;
  optional string next_page_token = 2;
}

message Sandbox {
  string sandbox_id = 1;
  AgentType agent_type = 2;
  string organization_id = 3;
  string session_id = 4;
  google.protobuf.Timestamp created_at = 5;
  optional google.protobuf.Timestamp started_at = 6;
  optional google.protobuf.Timestamp completed_at = 7;
  optional int32 exit_code = 8;
  optional double duration_seconds = 9;
  optional string error_message = 10;
  optional bool ssh_enabled = 11;
  optional string ssh_host = 12;
  optional int32 ssh_port = 13;
  optional string template_name = 14;
  optional string repository = 15;
}

message KillSandboxRequest {
  string sandbox_id = 1;
}

message KillSandboxResponse {}

message StreamSandboxLogsRequest {
  string sandbox_id = 1;
}

message StreamSandboxLogsResponse {
  LogEvent event = 1;

  message LogEvent {
    bytes data = 1;
    google.protobuf.Timestamp timestamp = 2;
    LogType type = 3;

    enum LogType {
      LOG_TYPE_UNSPECIFIED = 0;
      LOG_TYPE_STDOUT = 1;
      LOG_TYPE_STDERR = 2;
    }
  }
}

message ShutdownRequest {
  string sandbox_id = 1;
}

message ShutdownResponse {}

// ============================================================================
// Sandbox Template Messages
// ============================================================================

// SandboxTemplate represents a saved filesystem state that can be used to create new sandboxes
message SandboxTemplate {
  string id = 1;
  string organization_id = 2;
  string name = 3;
  optional string description = 4;

  // Source information (from the sandbox that was used to create this template)
  optional string source_repository = 5;
  optional string source_branch = 6;
  optional string source_commit_hash = 7;

  // Whether this template can be used with SSH mode
  bool ssh_compatible = 8;

  google.protobuf.Timestamp created_at = 9;
}

// CreateSandboxTemplate creates a new template from a running sandbox's filesystem
message CreateSandboxTemplateRequest {
  // The running sandbox to snapshot
  string sandbox_id = 1;
  // Unique name for the template within the organization
  string name = 2;
  // Optional description
  optional string description = 3;
}

message CreateSandboxTemplateResponse {
  SandboxTemplate template = 1;
}

// GetSandboxTemplate retrieves a template by ID
message GetSandboxTemplateRequest {
  string template_id = 1;
}

message GetSandboxTemplateResponse {
  SandboxTemplate template = 1;
}

// ListSandboxTemplates lists all templates for an organization
message ListSandboxTemplatesRequest {
  optional int32 page_size = 1;
  optional string page_token = 2;
}

message ListSandboxTemplatesResponse {
  repeated SandboxTemplate templates = 1;
  optional string next_page_token = 2;
}

// DeleteSandboxTemplate soft-deletes a template
message DeleteSandboxTemplateRequest {
  string template_id = 1;
}

message DeleteSandboxTemplateResponse {}
